<!DOCTYPE html>
<html lang="en">
<head>
    <link href="logo.png" rel="icon"/>
    <meta charset="UTF-8">
    <title>Oct7 Database Viewer</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- jQuery UI for resizable -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #ede0d4;
        }
        #filters { margin-bottom: 20px; }
        label { margin-right: 10px; }
        .logo-topright {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            z-index: 10;
        }
        #oct7table td {
            max-width: 15ch;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        #oct7table th {
            position: relative;
            position: sticky;
            top: 0;
            background-color: #ede0d4;
            z-index: 10;
        }
        #oct7table th:nth-child(1),
        #oct7table th:nth-child(2),
        #oct7table th:nth-child(3) {
            z-index: 11;
        }
        #oct7table td:nth-child(1) {
            position: sticky;
            left: 0;
            background-color: #ede0d4;
            z-index: 1;
        }
        #oct7table td:nth-child(2) {
            position: sticky;
            left: 0;
            background-color: #ede0d4;
            z-index: 1;
        }
        #oct7table td:nth-child(3) {
            position: sticky;
            left: 0;
            background-color: #ede0d4;
            z-index: 1;
        }
        .resizer {
            position: absolute;
            top: 0;
            right: 0;
            width: 10px;
            cursor: col-resize;
            user-select: none;
            height: 100%;
            z-index: 1000;
            background: transparent;
        }
        .resizer:hover {
            background-color: rgba(76, 175, 80, 0.5);
        }
    </style>
</head>
<body>
        <img src="logo.png" alt="oct7database logo" class="logo-topright">
        <h2>October 7 Database</h2>
        <span>
            <a href="https://oct7database.com" target="_blank">oct7database.com</a>
            <button style="margin-left:10px;vertical-align:middle;" onclick="window.open('table.html', '_blank')">Hebrew</button>
        </span><br><br>
    <div id="filters"></div>
    <table id="oct7table" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
    </table>
    <script>
    // Load CSV and initialize DataTable
    Papa.parse("https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv", {
        download: true,
        header: true,
        complete: function(results) {
            var data = results.data;
            var hideCols = ['שם פרטי', 'שם משפחה', 'שם נוסף', 'כינוי', 'מקום האירוע', 'מקום המוות', 'Event location class', 'Death location class'];
            var columns = Object.keys(data[0])
                .filter(function(col) { return hideCols.indexOf(col) === -1; })
                .map(function(col) {
                    return { title: col, data: col };
                });

            // Build table header
            var thead = $("#oct7table thead");
            var headerRow = "<tr>";
            columns.forEach(function(col) { headerRow += "<th>" + col.title + "</th>"; });
            headerRow += "</tr>";
            thead.html(headerRow);

            // Build table body
            var tbody = $("#oct7table tbody");
            data.forEach(function(row) {
                var tr = "<tr>";
                columns.forEach(function(col) {
                    var cellData = row[col.data] || "";
                    // Make links clickable in הנצחה column
                    if (col.data === 'הנצחה' && cellData && cellData.match(/https?:\/\/[^\s]+/)) {
                        cellData = cellData.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
                    }
                    // Make links for הספרייה הלאומית column
                    if (col.data === 'הספריה הלאומית' && cellData) {
                        cellData = '<a href="https://www.nli.org.il/he/authorities/' + cellData + '" target="_blank">' + cellData + '</a>';
                    }
                    tr += "<td>" + cellData + "</td>";
                });
                tr += "</tr>";
                tbody.append(tr);
            });

            // Initialize DataTable
            var table = $('#oct7table').DataTable({
                dom: 'lrt', // Hide default search box and length menu
                order: [],
                paging: false, // Show all rows, no pagination
                autoWidth: false
            });

            // Function to update sticky column positions
            function updateStickyColumns() {
                var col1Width = $('#oct7table th:nth-child(1)').outerWidth();
                var col2Width = $('#oct7table th:nth-child(2)').outerWidth();
                
                // For LTR: second column is at col1Width from left, third is at col1Width + col2Width
                $('#oct7table th:nth-child(2), #oct7table td:nth-child(2)').css('left', col1Width + 'px');
                $('#oct7table th:nth-child(3), #oct7table td:nth-child(3)').css('left', (col1Width + col2Width) + 'px');
            }

            // Add resize handles to columns
            setTimeout(function() {
                updateStickyColumns();
                $('#oct7table thead th').each(function() {
                    var $th = $(this);
                    var $resizer = $('<div class="resizer"></div>');
                    $th.append($resizer);
                    
                    $resizer.on('mousedown', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        var startX = e.pageX;
                        var startWidth = $th.outerWidth();
                        
                        $(document).on('mousemove.resize', function(e) {
                            e.preventDefault();
                            var width = startWidth + (e.pageX - startX);
                            if (width > 50) {
                                $th.css('width', width + 'px');
                                $th.css('min-width', width + 'px');
                                $th.css('max-width', width + 'px');
                            }
                        });
                        
                        $(document).on('mouseup.resize', function() {
                            $(document).off('mousemove.resize mouseup.resize');
                            updateStickyColumns();
                        });
                    });
                });
            }, 100);

            // Build filters for categorical columns and date range
            var filterHtml = '';
            var todayStr = new Date().toISOString().slice(0,10);
            var oct7Str = '2023-10-07';
            filterHtml += `<div id="search-row"><label>Free search: <input type="text" id="globalSearch" placeholder="Search all columns..."></label> `;
            columns.forEach(function(col, idx) {
                if (
                    data.length > 0 &&
                    data[0][col.title] &&
                    data[0][col.title].length < 30 &&
                    !col.title.toLowerCase().includes('location class') &&
                    !col.title.toLowerCase().includes('date')
                ) {
                    var uniqueVals = [...new Set(data.map(row => row[col.title]).filter(v => v))].sort();
                    if (uniqueVals.length > 1 && uniqueVals.length < 50) {
                        filterHtml += `<label>${col.title}: <select id="filter${idx}"><option value="">All</option>`;
                        uniqueVals.forEach(function(val) {
                            filterHtml += `<option value="${val}">${val}</option>`;
                        });
                        filterHtml += `</select></label>`;
                    }
                }
            });
            filterHtml += `</div><div id="date-row" style="margin-top:10px;">`;
            columns.forEach(function(col, idx) {
                if (col.title.toLowerCase().includes('date')) {
                    filterHtml += `<label>${col.title} from <input type="date" id="minDate${idx}" value="${oct7Str}"> to <input type="date" id="maxDate${idx}" value="${todayStr}"></label> `;
                }
            });
            filterHtml += `</div><div id="download-row" style="margin-top:10px;">
                <button id="downloadFullXLSX">Download full table (XLSX)</button>
                <button id="downloadFilteredXLSX">Download filtered data (XLSX)</button>
            </div>`;
            $("#filters").html(filterHtml);

            // Filtering logic
                        // XLSX download logic
                        function exportToXLSX(rows, cols, filename) {
                            var wb = XLSX.utils.book_new();
                            var ws_data = [cols.map(c => c.title)];
                            rows.forEach(function(row) {
                                ws_data.push(cols.map(c => row[c.title]));
                            });
                            var ws = XLSX.utils.aoa_to_sheet(ws_data);
                            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                            XLSX.writeFile(wb, filename);
                        }
                        // Load SheetJS
                        if (typeof XLSX === 'undefined') {
                            var xlsxScript = document.createElement('script');
                            xlsxScript.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
                            document.head.appendChild(xlsxScript);
                        }
                        $('#downloadFullXLSX').on('click', function() {
                            exportToXLSX(data, columns, 'oct7database_full.xlsx');
                        });
                        $('#downloadFilteredXLSX').on('click', function() {
                            var filteredIndexes = table.rows({ filter: 'applied' }).indexes().toArray();
                            var filteredRows = filteredIndexes.map(function(idx) { return data[idx]; });
                            exportToXLSX(filteredRows, columns, 'oct7database_filtered.xlsx');
                        });
            // Free search bar
            $('#globalSearch').on('input', function() {
                table.search(this.value).draw();
            });

            columns.forEach(function(col, idx) {
                // Dropdown filter
                $(`#filter${idx}`).on('change', function() {
                    table.column(idx).search(this.value).draw();
                });
                // Date range filter
                if (col.title.toLowerCase().includes('date')) {
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        var min = $(`#minDate${idx}`).val();
                        var max = $(`#maxDate${idx}`).val();
                        var dateStr = data[idx];
                        if (!dateStr) return true;
                        var date = new Date(dateStr);
                        if ((min && date < new Date(min)) || (max && date > new Date(max))) return false;
                        return true;
                    });
                    $(`#minDate${idx}, #maxDate${idx}`).on('change', function() {
                        table.draw();
                    });
                }
            });
        }
    });
    </script>
</body>
</html>
