<!-- Save as oct7database_viewer.html and open in your browser -->
<!DOCTYPE html>
<html lang="en">
<head>
    <link href="logo.png" rel="icon"/>
    <meta charset="UTF-8">
    <title>Oct7 Database Viewer</title>
    <!-- DataTables CSS -->
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <!-- DataTables JS -->
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #ede0d4;
        }
        #filters { margin-bottom: 20px; }
        label { margin-right: 10px; }
        .logo-topright {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 10px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <img src="logo.png" alt="oct7database logo" class="logo-topright">
    <h2>Oct7 Database Viewer</h2>
    <div id="filters"></div>
    <table id="oct7table" class="display" style="width:100%">
        <thead></thead>
        <tbody></tbody>
    </table>
    <script>
    // Load CSV and initialize DataTable
    Papa.parse("https://raw.githubusercontent.com/yuval-harpaz/alarms/refs/heads/master/data/oct7database.csv", {
        download: true,
        header: true,
        complete: function(results) {
            var data = results.data;
            var columns = Object.keys(data[0]).map(function(col) {
                return { title: col, data: col };
            });

            // Build table header
            var thead = $("#oct7table thead");
            var headerRow = "<tr>";
            columns.forEach(function(col) { headerRow += "<th>" + col.title + "</th>"; });
            headerRow += "</tr>";
            thead.html(headerRow);

            // Build table body
            var tbody = $("#oct7table tbody");
            data.forEach(function(row) {
                var tr = "<tr>";
                columns.forEach(function(col) {
                    tr += "<td>" + (row[col.title] || "") + "</td>";
                });
                tr += "</tr>";
                tbody.append(tr);
            });

            // Initialize DataTable
            var table = $('#oct7table').DataTable({
                dom: 'lrt', // Hide default search box and length menu
                order: [],
                paging: false // Show all rows, no pagination
            });

            // Build filters for categorical columns and date range
            var filterHtml = '';
            var todayStr = new Date().toISOString().slice(0,10);
            var oct7Str = '2023-10-07';
            filterHtml += `<div id="search-row"><label>Free search: <input type="text" id="globalSearch" placeholder="Search all columns..."></label> `;
            columns.forEach(function(col, idx) {
                if (
                    data.length > 0 &&
                    data[0][col.title] &&
                    data[0][col.title].length < 30 &&
                    !col.title.toLowerCase().includes('location class') &&
                    !col.title.toLowerCase().includes('date')
                ) {
                    var uniqueVals = [...new Set(data.map(row => row[col.title]).filter(v => v))].sort();
                    if (uniqueVals.length > 1 && uniqueVals.length < 50) {
                        filterHtml += `<label>${col.title}: <select id="filter${idx}"><option value="">All</option>`;
                        uniqueVals.forEach(function(val) {
                            filterHtml += `<option value="${val}">${val}</option>`;
                        });
                        filterHtml += `</select></label>`;
                    }
                }
            });
            filterHtml += `</div><div id="date-row" style="margin-top:10px;">`;
            columns.forEach(function(col, idx) {
                if (col.title.toLowerCase().includes('date')) {
                    filterHtml += `<label>${col.title} from <input type="date" id="minDate${idx}" value="${oct7Str}"> to <input type="date" id="maxDate${idx}" value="${todayStr}"></label> `;
                }
            });
            filterHtml += `</div><div id="download-row" style="margin-top:10px;">
                <button id="downloadFullXLSX">Download full table (XLSX)</button>
                <button id="downloadFilteredXLSX">Download filtered data (XLSX)</button>
            </div>`;
            $("#filters").html(filterHtml);

            // Filtering logic
                        // XLSX download logic
                        function exportToXLSX(rows, cols, filename) {
                            var wb = XLSX.utils.book_new();
                            var ws_data = [cols.map(c => c.title)];
                            rows.forEach(function(row) {
                                ws_data.push(cols.map(c => row[c.title]));
                            });
                            var ws = XLSX.utils.aoa_to_sheet(ws_data);
                            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
                            XLSX.writeFile(wb, filename);
                        }
                        // Load SheetJS
                        if (typeof XLSX === 'undefined') {
                            var xlsxScript = document.createElement('script');
                            xlsxScript.src = "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js";
                            document.head.appendChild(xlsxScript);
                        }
                        $('#downloadFullXLSX').on('click', function() {
                            exportToXLSX(data, columns, 'oct7database_full.xlsx');
                        });
                        $('#downloadFilteredXLSX').on('click', function() {
                            var filteredIndexes = table.rows({ filter: 'applied' }).indexes().toArray();
                            var filteredRows = filteredIndexes.map(function(idx) { return data[idx]; });
                            exportToXLSX(filteredRows, columns, 'oct7database_filtered.xlsx');
                        });
            // Free search bar
            $('#globalSearch').on('input', function() {
                table.search(this.value).draw();
            });

            columns.forEach(function(col, idx) {
                // Dropdown filter
                $(`#filter${idx}`).on('change', function() {
                    table.column(idx).search(this.value).draw();
                });
                // Date range filter
                if (col.title.toLowerCase().includes('date')) {
                    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
                        var min = $(`#minDate${idx}`).val();
                        var max = $(`#maxDate${idx}`).val();
                        var dateStr = data[idx];
                        if (!dateStr) return true;
                        var date = new Date(dateStr);
                        if ((min && date < new Date(min)) || (max && date > new Date(max))) return false;
                        return true;
                    });
                    $(`#minDate${idx}, #maxDate${idx}`).on('change', function() {
                        table.draw();
                    });
                }
            });
        }
    });
    </script>
</body>
</html>
